<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fees Dashboard</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
    }

    body {
      margin: 0;
      font-family: Arial, sans-serif;
      display: flex;
      height: 100vh;
    }

    .sidebar {
      width: 240px;
      background-color: #2f3542;
      color: white;
      padding: 20px 0;
    }

    .sidebar h2 {
      text-align: center;
      margin-bottom: 30px;
      font-size: 1.4rem;
    }

    .sidebar a {
      display: block;
      color: white;
      padding: 15px 20px;
      text-decoration: none;
      transition: 0.3s;
    }

    .sidebar a:hover,
    .sidebar a.active {
      background-color: #57606f;
    }

    .main {
      flex-grow: 1;
      padding: 20px;
    }

    select, button, input {
      padding: 8px;
      margin-right: 10px;
      margin-bottom: 10px;
    }

    table {
      margin-top: 20px;
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 10px;
      border: 1px solid #ccc;
      text-align: left;
    }

    th {
      background: #f0f0f0;
    }

    .no-data {
      margin-top: 20px;
      color: gray;
    }

    /* Modal Styling */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.4);
    }

    .modal-content {
      background-color: #fff;
      margin: 10% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 400px;
      border-radius: 10px;
    }

    .close {
      float: right;
      font-size: 1.2rem;
      cursor: pointer;
    }

    #loadingOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    .spinner {
      border: 8px solid #f3f3f3;
      border-top: 8px solid #3498db;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
<div id="loadingOverlay" style="display:none;">
  <div class="spinner"></div>
</div>

<div class="sidebar">
  <h2>Studia v1</h2>
  <a href="./index.html">Dashboard</a>
  <a href="./students.html">Student Directory</a>
  <a href="./marks.html">Marks Management</a>
  <a href="./fees.html" class="active">Fees Management</a>
  <a href="#">Exam & Timetable</a>
  <a href="#">Reports & Printouts</a>
  <a href="#">Notifications</a>
  <a href="#">Settings</a>
</div>

<div class="main">
  <h2>Fees Overview</h2>
  <label for="classSelect">Class:</label>
        <select id="classSelect">
          <option value="">Select Grade</option>
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
          <option value="6">6</option>
          <option value="7">7</option>
          <option value="8">8</option>
          <option value="9">9</option>
          <option value="10">10</option>
          <option value="11">11</option>
          <option value="12">12</option>
        </select>

  <label for="sectionSelect">Section:</label>
  <select id="sectionSelect">
    <option value="">Select Section</option>
    <option value="A">A</option>
    <option value="B">B</option>
    <option value="C">C</option>
  </select>

  <button onclick="loadStudents()">Load Students</button>
  <button onclick="openModal()">Add Payment</button>

  <div id="studentsTable"></div>
</div>

<!-- Payment Modal -->
<div id="paymentModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal()">&times;</span>
    <h3>Add Payment</h3>
    <form id="paymentForm">
      <label for="studentIdSelect">Student ID:</label>
      <select id="studentIdSelect" required onchange="populateName()"></select>

      <label for="studentName">Name:</label>
      <input type="text" id="studentName" disabled>

      <label for="amountPaid">Amount Paid:</label>
      <input type="number" id="amountPaid" required>

      <label for="paymentDate">Payment Date:</label>
      <input type="date" id="paymentDate" required>

      <label for="paymentMode">Payment Mode:</label>
      <select id="paymentMode">
        <option value="Cash">Cash</option>
        <option value="Bank Transfer">Bank Transfer</option>
        <option value="UPI">UPI</option>
        <option value="Other">Other</option>
      </select>

      <button type="submit">Submit</button>
    </form>
    <p id="message"></p>
  </div>
</div>

<script>
  let students = [];

  function showLoading() {
    document.getElementById("loadingOverlay").style.display = "flex";
  }

  function hideLoading() {
    document.getElementById("loadingOverlay").style.display = "none";
  }

  function openModal() {
    document.getElementById("paymentModal").style.display = "block";
    const studentDropdown = document.getElementById("studentIdSelect");
    studentDropdown.innerHTML = '<option value="">Select Student</option>';
    students.forEach(s => {
      const opt = document.createElement("option");
      opt.value = s.id;
      opt.text = `${s.id} - ${s.name}`;
      studentDropdown.appendChild(opt);
    });
  }

  function closeModal() {
    document.getElementById("paymentModal").style.display = "none";
  }

  function populateName() {
    const id = document.getElementById("studentIdSelect").value;
    const student = students.find(s => s.id === id);
    document.getElementById("studentName").value = student ? student.name : '';
  }

  async function loadStudents() {
    const classVal = document.getElementById('classSelect').value;
    const sectionVal = document.getElementById('sectionSelect').value;
    if (!classVal) return alert("Please select a class.");
    showLoading();

    try {
      const res = await fetch('/.netlify/functions/fetchStudents', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ class: classVal })
      });
      const result = await res.json();
      if (!result.success) throw new Error();

      students = result.data.filter(s => !sectionVal || s.section === sectionVal);
      if (students.length === 0) {
        document.getElementById("studentsTable").innerHTML = '<p class="no-data">No students found.</p>';
        return;
      }

      let tableHTML = `<table><thead><tr>
        <th>ID</th><th>Name</th><th>Class</th><th>Section</th><th>Stream</th><th>Phone</th><th>Total Paid</th>
      </tr></thead><tbody>`;

      for (const student of students) {
        const payRes = await fetch(`/.netlify/functions/getPayments?id=${student.id}`);
        const paymentData = await payRes.json();
        const totalPaid = Array.isArray(paymentData) ? paymentData.reduce((sum, p) => sum + Number(p.amount || 0), 0) : 0;

        tableHTML += `<tr>
          <td>${student.id}</td>
          <td style="cursor:pointer;color:blue;" onclick="showHistory('${student.id}')">${student.name}</td>
          <td>${student.class}</td>
          <td>${student.section}</td>
          <td>${student.stream || '-'}</td>
          <td>${student.phone}</td>
          <td>₹${totalPaid}</td>
        </tr>`;
      }

      tableHTML += `</tbody></table>`;
      document.getElementById("studentsTable").innerHTML = tableHTML;
    } catch (err) {
      document.getElementById("studentsTable").innerHTML = '<p class="no-data">Failed to load students.</p>';
    } finally {
      hideLoading();
    }
  }

  async function showHistory(studentId) {
    showLoading();
    try {
      const res = await fetch(`/.netlify/functions/getPayments?id=${studentId}`);
      const data = await res.json();
      if (!Array.isArray(data) || data.length === 0) return alert("No payments found.");

      const grouped = {};
      data.forEach(p => {
        const d = new Date(p.date);
        const key = `${d.getFullYear()}-${(d.getMonth() + 1).toString().padStart(2, '0')}`;
        if (!grouped[key]) grouped[key] = [];
        grouped[key].push(p);
      });

      let msg = "";
      for (const [month, payments] of Object.entries(grouped)) {
        msg += `\n${month}:\n`;
        payments.forEach(p => {
          msg += ` - ₹${p.amount} on ${new Date(p.date).toLocaleDateString()} via ${p.mode}\n`;
        });
      }

      alert(`Payment History for ${studentId}:\n` + msg);
    } catch (err) {
      alert("Failed to fetch payment history.");
    } finally {
      hideLoading();
    }
  }

  document.getElementById("paymentForm").addEventListener("submit", async function(event) {
    event.preventDefault();
    const studentId = document.getElementById("studentIdSelect").value;
    const amount = document.getElementById("amountPaid").value;
    const date = document.getElementById("paymentDate").value;
    const mode = document.getElementById("paymentMode").value;

    showLoading();
    try {
      const res = await fetch("/.netlify/functions/addPayment", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ studentId, amount, date, mode })
      });
      const result = await res.json();
      document.getElementById("message").textContent = result.message;
      if (result.success) {
        document.getElementById("paymentForm").reset();
        closeModal();
        loadStudents();
      }
    } catch (err) {
      document.getElementById("message").textContent = "Error adding payment.";
    } finally {
      hideLoading();
    }
  });
</script>
</body>
</html>
